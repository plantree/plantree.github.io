---
layout: post
title: String的简单实现
categories: [C++]
description: String的简单实现
keywords: C++, practice
---

标准库实现的`std::string`类，平时经常用到，里面功能很多，和标准库中的算法搭配的也很好。`C`语言中对于字符串的操作，其实是对于`*char`的操作。这听起来挺简单，似乎简单封装一下，就能实现自己的`String`类，就在网上找到一篇[文章](https://coolshell.cn/articles/10478.html)，不过八十几行的代码，功能倒是相当丰富，而且涉及到底层资源的管理问题，也就是`Big-5`怎么写（拷贝构造、赋值、移动构造、移动赋值和析构函数）。

这里的`String`类只是自我学习的玩具程序，自然不能和标准库相比，但是资源管理的手段和意识，是比代码本身更重要的。

#### Goal

通过简单封装，实现自己的`String`类，要求正确管理资源，具体是：

1. 可以定义变量、拷贝、赋值、移动拷贝、移动赋值
2. 可以作为函数参数传递，类型自动转换
3. 可以作为标准库容器的元素

#### Environment

- OS： ubuntu 18.04 (64 bit)
- Compiler: g++ 7.3.0

#### Step

#####　1. 实现

类图如下：

![](https://raw.githubusercontent.com/plantree/PictureBed/master/images/20190609144115.png)

成员变量只有两个，`char *_data`和`size_t _size`，一个存储底层字符串，另一个利用空间换时间，解决计算长度时的开销。

内存的分配和释放只发生在构造函数和析构函数中。

```c++
String() : _data(new char[1]), _size(0)
{
    *_data = '\0';
}
String(const char *str) 
    : _data(new char[strlen(str)+1]), _size(strlen(str))
    {
        strcpy(_data, str);
    }
~String()
{
    delete[] _data;
}
```

因为是构造函数，底层的指针必须要深拷贝，先索取内存空间，然后复制，析构的时候，因为是`new []`，因此要`delete []`。

比较复杂的是拷贝和移动语义。

```c++
// copy
String(const String &rhs)
    : _data(new char[rhs.size()+1]), _size(rhs.size())
    {
        strcpy(_data, rhs.c_str());   
    }
String &operator=(const String &rhs)  
{
    String temp(rhs);
    swap(temp);
    return *this;
}
void swap(String &rhs)
{
    std::swap(_data, rhs._data);
    std::swap(_size, rhs._size);
}
```

额外写了个辅助的`swap`函数。拷贝构造，过程与构造函数差不多，拷贝赋值有个小`trick`，借助一个临时的对象（其实是拷贝构造的间接调用），通过底层资源的交换完成赋值，原有的资源会自动的在离开函数的时候析构，借助已用工具管理资源，不必自己再额外的手动管理。

```c++
// move
String(String &&rhs) noexcept
    : _data(rhs._data), _size(rhs._size)
    {
        rhs._data = nullptr;
    }
String &operator=(String &&rhs) noexcept
{
    swap(rhs);
    return *this;
}
```

对于移动的操作来说，执行的是浅拷贝，只是交换指针的内容，记得将右值引用的指针赋空值，避免被析构掉。赋值的操作比较简单，直接交换底层资源就好。

##### 2. 测试结果

测试结果如下：

![](https://raw.githubusercontent.com/plantree/PictureBed/master/images/20190609150104.png)

相关代码都在这里[Github](https://github.com/plantree/Practice)

#### Thinking：

一个类，完成功能是一方面，正确的管理资源也是很重要的一个方面。C++提供的`Big-5`以及构造函数的使用，借助对象的生存期管理资源，避免手动的申请和释放，不进繁琐，而且容易出错。看的出来，比较复杂的，是拷贝和移动语义，四个函数不太好写。通过对资源封装，在更高层使用的时候，比如函数调用，比如作为容器元素，就不需要额外考虑资源的管理问题。

#### Reference：

- https://coolshell.cn/articles/10478.html

- 《C++ Primer》

  